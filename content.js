(()=>{var I=typeof browser<"u"?browser:chrome,ht={runtime:{onMessage:I.runtime.onMessage,sendMessage:(...l)=>I.runtime.sendMessage(...l),onInstalled:I.runtime.onInstalled},action:I.action||I.browserAction,tabs:I.tabs},A=ht;var R=" .'`^\",:;Il!i><~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";var c={bg:"#1e1e2e",surface:"#313244",overlay:"#45475a",text:"#cdd6f4",subtext:"#a6adc8",heading:"#f38ba8",link:"#89b4fa",linkVisited:"#cba6f7",keyword:"#f9e2af",string:"#a6e3a1",comment:"#6c7086",gutter:"#585b70",gutterBg:"#181825",statusBg:"#313244",statusText:"#cdd6f4",commandBg:"#1e1e2e",commandText:"#cdd6f4",cursor:"#f5e0dc",visual:"#45475a",search:"#f9e2af",modeNormal:"#89b4fa",modeInsert:"#a6e3a1",modeVisual:"#cba6f7",modeCommand:"#f9e2af",modeVideo:"#f38ba8",tilde:"#585b70",separator:"#45475a",code:"#a6e3a1",codeBg:"#181825"},_={NORMAL:"NORMAL",COMMAND:"COMMAND",VISUAL:"VISUAL",HINT:"HINT",VIDEO:"VIDEO"},O={LINE:1,HALF_PAGE:15,PAGE:30};var q="asdfghjklqwertyuiopzxcvbnm",X=12,U=5,G=.1,Q=500;var Y=new Set(["SCRIPT","STYLE","NOSCRIPT","TEMPLATE","HEAD","META","LINK","SVG","IFRAME","OBJECT","EMBED"]);function et(l=document.body){let t=new K;return t.process(l),t.getBlocks()}function T(l){return parseFloat(l)||0}var P=8.4;function S(l){return Math.max(0,Math.round(l/P))}function ct(l){return Math.max(0,Math.round(l/19.6))}function Z(l,t,e){let s=i=>(i/=255,i<=.03928?i/12.92:((i+.055)/1.055)**2.4);return .2126*s(l)+.7152*s(t)+.0722*s(e)}function J(l){if(!l||l==="transparent"||l==="rgba(0, 0, 0, 0)")return null;let t=l.match(/rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)/);return t?[+t[1],+t[2],+t[3]]:null}function dt(l,t){let e=J(l),s=J(t);if(!e||!s)return!1;let i=Z(...e),n=Z(...s);return(Math.max(i,n)+.05)/(Math.min(i,n)+.05)<1.15}function tt(l,t,e,s){return{width:l,indent:t,align:e,textIndent:s,firstLine:!0}}var K=class{constructor(){this.blocks=[],this.inlineBuf="",this.inlineLinks=[],this.listStack=[],this.quoteDepth=0,this.preDepth=0;let t=document.documentElement.clientWidth||window.innerWidth||1024,e=Math.max(80,S(t));this.ctxStack=[tt(e,0,"left",0)]}get _ctx(){return this.ctxStack[this.ctxStack.length-1]}process(t){this._walk(t),this._flush()}getBlocks(){let t=[];for(let o of this.blocks)o.type==="blank"&&t.length&&t[t.length-1].type==="blank"||t.push(o);for(;t.length&&t[0].type==="blank";)t.shift();for(;t.length&&t[t.length-1].type==="blank";)t.pop();let e=80,s=t.filter(o=>o.type!=="blank"),i=s.map(o=>o.indent||0);if(i.length){let o=Math.min(...i);if(o>0)for(let a of t)a.indent!=null&&(a.indent=Math.max(0,a.indent-o))}let n=Math.floor(e*.25),r=s.map(o=>o.indent||0),h=r.length?Math.max(...r):0;if(h>n){let o=n/h;for(let a of t)a.indent!=null&&a.indent>0&&(a.indent=Math.round(a.indent*o))}for(let o of t){if(o.type==="blank")continue;let a=o.indent||0;o.wrapWidth!=null&&(o.wrapWidth=Math.min(o.wrapWidth,Math.max(1,e-a)))}return t}_pushCtx(t,e){let s=this._ctx,i=t.getBoundingClientRect(),n=S(i.width),r=S(T(e.paddingLeft)),h=S(T(e.paddingRight)),o=S(T(e.marginLeft)),a=S(T(e.textIndent)),p=e.textAlign||s.align,f=n>0?Math.max(1,n-r-h):Math.max(1,s.width-o-r);this.ctxStack.push(tt(f,s.indent+o+r,p,a))}_popCtx(){this.ctxStack.length>1&&this.ctxStack.pop()}_walk(t){if(t.nodeType===Node.TEXT_NODE){this._text(t);return}if(t.nodeType!==Node.ELEMENT_NODE)return;let e=t,s=e.tagName;if(Y.has(s)||e.id==="vimascii-host"||e.hidden)return;let i;try{i=window.getComputedStyle(e)}catch{return}let n=i.display;if(n==="none"||i.visibility==="hidden"||i.visibility==="collapse"||i.opacity==="0"||e.offsetWidth===0&&e.offsetHeight===0&&i.overflow!=="visible"||dt(i.color,i.backgroundColor))return;if(n==="contents"){this._kids(e);return}let r=this._isBlk(n),h=i.whiteSpace||"",o=h==="pre"||h==="pre-wrap"||h==="pre-line";r&&(this._flush(),this._mblank(i,"Top"),this._pushCtx(e,i)),this._dispatch(e,s,i,n,r,o),r&&(this._flush(),this._popCtx(),this._mblank(i,"Bottom"))}_dispatch(t,e,s,i,n,r){if(e==="BR"){this._flush();return}if(e==="HR"){let o=this._ctx;this.blocks.push({type:"separator",text:"\u2500".repeat(Math.min(o.width,80)),indent:o.indent});return}if(e==="VIDEO"){this._video(t);return}if(e==="IMG"){this._img(t,s,n);return}if(e==="TABLE"||i==="table"||i==="inline-table"){this._table(t,s);return}let h=e.match(/^H([1-6])$/);if(h){this._heading(t,s,+h[1]);return}if(e==="UL"||e==="OL"){this.listStack.push({type:e==="OL"?"ol":"ul",counter:0}),this._kids(t),this.listStack.pop();return}if(e==="LI"||i==="list-item"){this._li(t,s);return}if(e==="DL"){this._kids(t);return}if(e==="DT"){let o=this._extractInline(t),a=this._ctx;this.blocks.push({type:"text",text:o.text,links:o.links,indent:a.indent,wrapWidth:a.width,align:a.align});return}if(e==="DD"){let o=this._extractInline(t),a=this._ctx,p=Math.max(4,S(T(s.marginLeft)+T(s.paddingLeft)));this.blocks.push({type:"text",text:o.text,links:o.links,indent:a.indent+p,wrapWidth:Math.max(1,a.width-p),align:a.align});return}if(e==="PRE"){this._pre(t);return}if(e==="CODE"&&!this._inPre(t)){this.inlineBuf+=t.textContent;return}if(e==="BLOCKQUOTE"){this.quoteDepth++,this._kids(t),this._flush(),this.quoteDepth--;return}if(e==="DETAILS"){let o=t.querySelector(":scope > summary");if(o){let a=this._ctx;this.blocks.push({type:"text",text:(t.open?"\u25BC ":"\u25B6 ")+o.textContent.trim(),links:[],indent:a.indent,wrapWidth:a.width})}if(t.open)for(let a of t.childNodes)a!==o&&this._walk(a);return}if(e!=="SUMMARY"){if(e==="INPUT"){t.type!=="hidden"&&(this.inlineBuf+=`[${t.value||t.placeholder||t.type}]`);return}if(e==="BUTTON"){this.inlineBuf+=`[${t.textContent.trim()}]`;return}if(e==="SELECT"){let o=t.options?.[t.selectedIndex];this.inlineBuf+=`[${o?o.text:"select"}]`;return}if(e==="TEXTAREA"){this.blocks.push({type:"code",lines:(t.value||t.placeholder||"").split(`
`),indent:this._ctx.indent});return}if(e==="A"&&t.href){this._link(t,s);return}r&&this.preDepth++,this._kids(t),r&&this.preDepth--}}_kids(t){for(let e of t.childNodes)this._walk(e)}_text(t){let e=t.textContent;if(this.preDepth>0){this.inlineBuf+=e;return}let s=t.parentElement;if(s){let i;try{i=window.getComputedStyle(s)}catch{}if(i){e=this._tt(e,i.textTransform),T(i.letterSpacing)>=P*.8&&(e=e.split("").join(" "));let r=T(i.wordSpacing);if(r>=P*2){let h=Math.round(r/P);e=e.replace(/ /g," ".repeat(h))}}}e=e.replace(/[\r\n\t]+/g," ").replace(/ {2,}/g," "),e.startsWith(" ")&&(!this.inlineBuf.length||this.inlineBuf.endsWith(" "))&&(e=e.trimStart()),e&&(this.inlineBuf+=e)}_heading(t,e,s){let i=this._extractInline(t),n=this._ctx,r="#".repeat(s)+" ";this.blocks.push({type:"heading",level:s,text:r+i.text.trim(),links:this._off(i.links,r.length),indent:n.indent,wrapWidth:n.width,align:n.align})}_li(t,e){let s=this._ctx,i=this.listStack[this.listStack.length-1],n;if(i&&i.type==="ol")i.counter++,n=`${i.counter}. `;else{let r=e.listStyleType;n=r==="disc"?"\u25CF ":r==="circle"?"\u25CB ":r==="square"?"\u25A0 ":r==="none"?"":"- "}this.inlineBuf=n;for(let r of t.childNodes)r.nodeType===Node.ELEMENT_NODE&&(r.tagName==="UL"||r.tagName==="OL")?(this._flush(),this._walk(r)):this._walk(r)}_link(t){let e=this.inlineBuf.length;this._kids(t);let s=this.inlineBuf.length;s>e&&this.inlineLinks.push({start:e,end:s,href:t.href})}_img(t,e,s){let i=t.src||t.dataset?.src||"",n=t.alt||"",r=t.getBoundingClientRect();if(r.width>0&&r.height>0&&r.width<4&&r.height<4||!i)return;s||this._flush();let h=this._ctx;this.blocks.push({type:"image",src:i,alt:n,domElement:t,width:r.width,height:r.height,artWidth:Math.max(1,S(r.width)),artHeight:Math.max(1,ct(r.height)),indent:h.indent})}_video(t){let e=t.getBoundingClientRect();if(e.width<=0||e.height<=0)return;let s=this._ctx;this._flush(),this.blocks.push({type:"video",domElement:t,width:e.width,height:e.height,indent:s.indent})}_pre(t){let e=t.textContent;if(!e.trim())return;let s=e.split(`
`);for(;s.length&&!s[0].trim();)s.shift();for(;s.length&&!s[s.length-1].trim();)s.pop();this.blocks.push({type:"code",lines:s,indent:this._ctx.indent})}_table(t){let e=this._ctx,s=e.width,i=t.tagName==="TABLE"&&t.rows?Array.from(t.rows):Array.from(t.querySelectorAll("tr"));if(!i.length){this._kids(t);return}let n=[],r=[];for(let u of i){let d=u.parentElement?.tagName==="THEAD",x=[];for(let m of u.children){if(m.tagName!=="TD"&&m.tagName!=="TH")continue;let w=this._extractInline(m),k=S(m.getBoundingClientRect().width);x.push({text:w.text.trim().replace(/\s+/g," "),isH:m.tagName==="TH"||d,links:w.links,cw:k})}x.length&&(n.push(x),(d||x.every(m=>m.isH))&&r.push(n.length-1))}if(!n.length)return;let h=Math.max(...n.map(u=>u.length)),o=new Array(h).fill(0);for(let u of n)for(let d=0;d<u.length;d++)o[d]=Math.max(o[d],u[d].text.length,Math.min(u[d].cw||0,u[d].text.length+4));let a=Math.max(20,s-(h+1)-h*2),p=o.reduce((u,d)=>u+d,0);if(p>a){let u=a/p;for(let d=0;d<o.length;d++)o[d]=Math.max(1,Math.round(o[d]*u))}let f="+"+o.map(u=>"-".repeat(u+2)).join("+")+"+",v="+"+o.map(u=>"=".repeat(u+2)).join("+")+"+",g=e.indent;this.blocks.push({type:"table-border",text:f,indent:g});for(let u=0;u<n.length;u++){let d=n[u],x="|",m=[];for(let w=0;w<h;w++){let k=d[w]||{text:"",links:[]},E=k.text.slice(0,o[w]),b=x.length+1;x+=" "+E.padEnd(o[w])+" |";for(let y of k.links||[]){let L=Math.max(0,y.start),j=Math.min(y.end,E.length);j>L&&m.push({start:b+L,end:b+j,href:y.href})}}this.blocks.push({type:"table-row",text:x,links:m,indent:g}),r.includes(u)&&this.blocks.push({type:"table-border",text:v,indent:g})}r.includes(n.length-1)||this.blocks.push({type:"table-border",text:f,indent:g})}_flush(){let t=this.inlineBuf.trimEnd(),e=this.inlineLinks.slice();if(this.inlineBuf="",this.inlineLinks=[],!t)return;let s=this._ctx;if(this.quoteDepth>0){let i="> ".repeat(this.quoteDepth);t=i+t;for(let n=0;n<e.length;n++)e[n]={...e[n],start:e[n].start+i.length,end:e[n].end+i.length}}this.blocks.push({type:"text",text:t,links:e,indent:s.indent,wrapWidth:s.width,align:s.align,textIndent:s.firstLine?s.textIndent:0}),s.firstLine=!1}_blank(){let t=this.blocks[this.blocks.length-1];(!t||t.type!=="blank")&&this.blocks.push({type:"blank",text:""})}_mblank(t,e){let s=T(t["margin"+e])+T(t["padding"+e]),i=Math.min(3,Math.floor(s/20));for(let n=0;n<i;n++)this._blank();!i&&s>8&&this._blank()}_isBlk(t){return t!=="inline"&&t!=="inline-block"&&t!=="inline-flex"&&t!=="inline-grid"&&t!=="inline-table"&&t!=="contents"&&t!=="ruby"&&t!=="ruby-text"&&t!==""}_inPre(t){let e=t.parentElement;for(;e;){if(e.tagName==="PRE")return!0;e=e.parentElement}return!1}_tt(t,e){return!e||e==="none"?t:e==="uppercase"?t.toUpperCase():e==="lowercase"?t.toLowerCase():e==="capitalize"?t.replace(/\b\w/g,s=>s.toUpperCase()):t}_extractInline(t){let e="",s=[],i=n=>{if(n.nodeType===Node.TEXT_NODE){let h=n.textContent.replace(/\s+/g," "),o=n.parentElement;if(o)try{h=this._tt(h,window.getComputedStyle(o).textTransform)}catch{}e+=h;return}if(n.nodeType!==Node.ELEMENT_NODE||Y.has(n.tagName))return;let r;try{r=window.getComputedStyle(n)}catch{return}if(!(r.display==="none"||r.visibility==="hidden")){if(n.tagName==="BR"){e+=" ";return}if(n.tagName==="IMG"){n.alt&&(e+=`[${n.alt}]`);return}if(n.tagName==="A"&&n.href){let h=e.length;for(let a of n.childNodes)i(a);let o=e.length;o>h&&s.push({start:h,end:o,href:n.href});return}for(let h of n.childNodes)i(h)}};return i(t),{text:e,links:s}}_off(t,e){return t.map(s=>({start:s.start+e,end:s.end+e,href:s.href}))}};async function pt(l,t,e,s){if(s&&(s.naturalWidth>0||s.width>0)){let i=nt(s,t,e);if(i)return i}if(l.startsWith("data:")||l.startsWith("blob:")){try{let i=await it(l,t,e);if(i)return i}catch{}return null}try{let i=await mt(l);if(i){let n=await it(i,t,e);if(n)return n}}catch{}return null}function mt(l){return new Promise(t=>{try{A.runtime.sendMessage({type:"FETCH_IMAGE",url:l}).then(e=>t(e?.dataUrl||null)).catch(()=>t(null))}catch{t(null)}})}function it(l,t,e){return new Promise(s=>{let i=new Image;i.onload=()=>s(nt(i,t,e)),i.onerror=()=>s(null),i.src=l})}function nt(l,t,e){try{return ft(l,t,e)}catch{return null}}function ft(l,t,e){let s=l.naturalWidth||l.width,i=l.naturalHeight||l.height;if(s<1||i<1||s<4&&i<4)return null;let n,r;t>0&&e>0?(n=Math.min(t,140),r=e):(n=Math.min(Math.max(20,Math.round(s/6)),140),r=Math.round(i/s*n*.5)),n<1&&(n=1),r<1&&(r=1);let h=150;if(r>h){let d=h/r;r=h,n=Math.max(1,Math.round(n*d))}let o=document.createElement("canvas"),a=o.getContext("2d");o.width=n,o.height=r,a.drawImage(l,0,0,n,r);let p;try{p=a.getImageData(0,0,n,r)}catch{return null}let f=p.data,v=R,g=v.length,u=[];for(let d=0;d<r;d++){let x="";for(let m=0;m<n;m++){let w=(d*n+m)*4,k=f[w],E=f[w+1],b=f[w+2];if(f[w+3]<128)x+=" ";else{let L=.299*k+.587*E+.114*b;x+=v[Math.floor(L/255*(g-1))]}}u.push(x)}return u}async function rt(l){let e=l.filter(s=>s.type==="image"&&s.src).map(async s=>{let i=await pt(s.src,s.artWidth||0,s.artHeight||0,s.domElement||null);i&&(s.asciiLines=i)});await Promise.all(e)}function ot(l,t=80){let e=[];for(let s of l){let i=s.indent||0;switch(s.type){case"heading":{let n=s.wrapWidth||t,r=gt(s.text,n);for(let h of r)e.push({type:"heading",level:s.level,text:C(i)+z(h,s.align,n),links:xt(s.links,i,s.text,h)});break}case"text":vt(s,t,e);break;case"video":e.push({type:"video-placeholder",text:C(i)+"[VIDEO - Enter\u3067\u518D\u751F]",links:[],videoElement:s.domElement});break;case"image":if(s.asciiLines&&s.asciiLines.length>0){for(let n of s.asciiLines)e.push({type:"ascii-art",text:C(i)+n});s.alt&&e.push({type:"text",text:C(i)+`  [${s.alt}]`,links:[]})}else{let n=s.alt?`[IMAGE: ${s.alt}]`:"[IMAGE]";e.push({type:"text",text:C(i)+n,links:[]})}break;case"separator":e.push({type:"separator",text:C(i)+s.text});break;case"code":if(s.lines){e.push({type:"separator",text:C(i)+"```"});for(let n of s.lines)e.push({type:"code",text:C(i)+n});e.push({type:"separator",text:C(i)+"```"})}break;case"table-border":e.push({type:"separator",text:C(i)+s.text});break;case"table-row":e.push({type:"text",text:C(i)+s.text,links:(s.links||[]).map(n=>({...n,start:n.start+i,end:n.end+i}))});break;case"blank":(!e.length||e[e.length-1].type!=="blank")&&e.push({type:"blank",text:""});break;default:s.text&&e.push({type:"text",text:C(i)+s.text,links:(s.links||[]).map(n=>({...n,start:n.start+i,end:n.end+i}))});break}}for(;e.length&&e[e.length-1].type==="blank";)e.pop();return e}function C(l){return l>0?" ".repeat(l):""}function z(l,t,e){if(!t||t==="left"||t==="start")return l;let s=Math.max(0,e-l.length);return t==="center"?C(Math.floor(s/2))+l:t==="right"||t==="end"?C(s)+l:l}function gt(l,t){if(l.length<=t)return[l];let e=[],s=0;for(;s<l.length;){let i=s+t;if(i>=l.length)i=l.length;else{let n=l.lastIndexOf(" ",i);n>s&&(i=n+1)}i===s&&(i=s+t),e.push(l.slice(s,i)),s=i}return e}function xt(l,t,e,s){return!l||!l.length?[]:l.filter(i=>s.includes(e.slice(i.start,i.end))).map(i=>{let n=s.indexOf(e.slice(i.start,i.end));return n>=0?{start:n+t,end:n+(i.end-i.start)+t,href:i.href}:null}).filter(Boolean)}function vt(l,t,e){let s=l.text||"",i=l.links||[],n=l.indent||0,r=l.wrapWidth||t-n,h=l.align||"left",o=l.textIndent||0,a=s.match(/^([●○■\-*] |\d+\.\s)/),p=a?a[1].length:0;if(s.length+o<=r&&!o){let g=z(s,h,r);e.push({type:"text",text:C(n)+g,links:i.map(u=>({...u,start:u.start+n,end:u.end+n}))});return}let f=0,v=!0;for(;f<s.length;){let g=v?o:p||0,u=Math.max(1,r-g),d=f+u;if(d>=s.length)d=s.length;else{let y=s.lastIndexOf(" ",d);y>f&&(d=y+1)}d===f&&(d=f+u);let x=s.slice(f,d),m=v||p?C(g):"",w=m+x,k=z(w,h,r),E=n,b=[];for(let y of i){if(y.end<=f||y.start>=d)continue;let L=m.length+E;b.push({start:Math.max(0,y.start-f)+L,end:Math.min(x.length,y.end-f)+L,href:y.href})}e.push({type:"text",text:C(E)+k,links:b}),f=d,v=!1}}var H=class{constructor(){this.el=null,this.modeEl=null,this.fileEl=null,this.posEl=null,this.scrollEl=null,this.mode=_.NORMAL}create(){return this.el=document.createElement("div"),this.el.className="vim-statusline",this.modeEl=document.createElement("span"),this.modeEl.className="vim-statusline-mode vim-statusline-mode-normal",this.modeEl.textContent=" NORMAL ",this.fileEl=document.createElement("span"),this.fileEl.className="vim-statusline-file",this.fileEl.textContent="",this.posEl=document.createElement("span"),this.posEl.className="vim-statusline-pos",this.posEl.textContent="1,1",this.scrollEl=document.createElement("span"),this.scrollEl.className="vim-statusline-scroll",this.scrollEl.textContent="Top",this.el.appendChild(this.modeEl),this.el.appendChild(this.fileEl),this.el.appendChild(this.posEl),this.el.appendChild(this.scrollEl),this.el}setMode(t){this.mode=t;let e=t.toLowerCase();this.modeEl.className=`vim-statusline-mode vim-statusline-mode-${e}`,this.modeEl.textContent=` ${t} `}update({cursor:t,scroll:e,file:s}){t&&(this.posEl.textContent=`${t.row},${t.col}`),e!==void 0&&(this.scrollEl.textContent=e),s!==void 0&&(this.fileEl.textContent=s)}};var D=class{constructor(){this.el=null,this.prefixEl=null,this.inputEl=null,this.messageEl=null}create(){return this.el=document.createElement("div"),this.el.className="vim-commandline",this.prefixEl=document.createElement("span"),this.prefixEl.className="vim-commandline-prefix",this.prefixEl.textContent="",this.inputEl=document.createElement("input"),this.inputEl.type="text",this.inputEl.className="vim-commandline-input",this.inputEl.style.display="none",this.inputEl.setAttribute("autocomplete","off"),this.inputEl.setAttribute("autocorrect","off"),this.inputEl.setAttribute("spellcheck","false"),this.messageEl=document.createElement("span"),this.messageEl.className="vim-commandline-message",this.messageEl.textContent="",this.el.appendChild(this.prefixEl),this.el.appendChild(this.inputEl),this.el.appendChild(this.messageEl),this.el}activate(t){this.prefixEl&&(this.prefixEl.textContent=t,this.inputEl.value="",this.inputEl.style.display="",this.messageEl.style.display="none",this.messageEl.textContent="",setTimeout(()=>{this.inputEl&&this.inputEl.focus()},0))}deactivate(){this.prefixEl&&(this.prefixEl.textContent="",this.inputEl.style.display="none",this.inputEl.value="",this.messageEl.style.display="")}getInputValue(){return this.inputEl?.value||""}showMessage(t,e=!1){this.prefixEl&&(this.prefixEl.textContent="",this.inputEl.style.display="none",this.messageEl.style.display="",this.messageEl.textContent=t,this.messageEl.className=e?"vim-commandline-error":"vim-commandline-message")}clear(){this.prefixEl&&(this.prefixEl.textContent="",this.inputEl.style.display="none",this.inputEl.value="",this.messageEl.textContent="")}isInputActive(){return!1}};var B=class{constructor(){this.host=null,this.shadow=null,this.root=null,this.bufferEl=null,this.viewportEl=null,this.statusline=null,this.commandline=null,this.lines=[],this.scrollTop=0,this.cursorRow=0,this.cursorCol=0,this.viewportRows=0,this.isVisible=!1,this._renderScheduled=!1,this._originalOverflow="",this._measuredLineHeight=0,this._resizeObserver=null,this._wheelHandler=null,this.videoPlayer=null,this._savedVideoState=null,this.searchPattern="",this.searchMatchLines=new Set,this.searchCurrentLine=-1}create(){this.host=document.createElement("div"),this.host.id="vimascii-host",this.shadow=this.host.attachShadow({mode:"closed"});let t=document.createElement("style");t.textContent=this._getCSS(),this.shadow.appendChild(t),this.root=document.createElement("div"),this.root.className="vimascii-root",this.bufferEl=document.createElement("div"),this.bufferEl.className="vim-buffer",this.viewportEl=document.createElement("div"),this.viewportEl.className="vim-buffer-viewport",this.bufferEl.appendChild(this.viewportEl),this.statusline=new H;let e=this.statusline.create();this.commandline=new D;let s=this.commandline.create();return this.root.appendChild(this.bufferEl),this.root.appendChild(e),this.root.appendChild(s),this.shadow.appendChild(this.root),document.documentElement.appendChild(this.host),this._resizeObserver=new ResizeObserver(()=>{this._calculateViewport(),this.scheduleRender()}),this._resizeObserver.observe(this.bufferEl),this._wheelHandler=i=>{if(!this.isVisible)return;i.preventDefault();let n=Math.sign(i.deltaY)*3;this.cursorRow=Math.max(0,Math.min(this.cursorRow+n,this.lines.length-1)),this._ensureCursorVisible(),this.scheduleRender()},this.host.addEventListener("wheel",this._wheelHandler,{passive:!1}),this._windowWheelHandler=i=>{if(!this.isVisible)return;i.preventDefault();let n=Math.sign(i.deltaY)*3;this.cursorRow=Math.max(0,Math.min(this.cursorRow+n,this.lines.length-1)),this._ensureCursorVisible(),this.scheduleRender()},window.addEventListener("wheel",this._windowWheelHandler,{passive:!1,capture:!0}),this}show(){this.host||this.create(),this._originalOverflow=document.body.style.overflow,document.body.style.overflow="hidden",this.host.style.display="",this.isVisible=!0,requestAnimationFrame(()=>{this._calculateViewport(),this.render()})}hide(){this.host&&(this.host.style.display="none",document.body.style.overflow=this._originalOverflow),this.isVisible=!1}destroy(){this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this._windowWheelHandler&&(window.removeEventListener("wheel",this._windowWheelHandler,{capture:!0}),this._windowWheelHandler=null),this.host&&this.host.parentNode&&(this.host.parentNode.removeChild(this.host),document.body.style.overflow=this._originalOverflow),this.host=null,this.shadow=null,this.isVisible=!1}setLines(t){this.lines=t,this.scrollTop=0,this.cursorRow=0,this.cursorCol=0,this.scheduleRender()}setCursor(t,e){this.cursorRow=Math.max(0,Math.min(t,this.lines.length-1)),this.cursorCol=Math.max(0,e),this._ensureCursorVisible(),this.scheduleRender()}getCursor(){return{row:this.cursorRow,col:this.cursorCol}}getViewportRows(){return this.viewportRows}getTotalLines(){return this.lines.length}scrollTo(t){this.scrollTop=Math.max(0,Math.min(t,this.lines.length-1)),this.scheduleRender()}scrollBy(t){this.scrollTo(this.scrollTop+t)}_ensureCursorVisible(){let t=this.viewportRows||30;this.cursorRow<this.scrollTop?this.scrollTop=this.cursorRow:this.cursorRow>=this.scrollTop+t&&(this.scrollTop=this.cursorRow-t+1),this.scrollTop=Math.max(0,this.scrollTop)}_calculateViewport(){if(!this.bufferEl)return;let t=this._measuredLineHeight;if(!t){let i=document.createElement("div");i.className="vim-line",i.style.visibility="hidden",i.style.position="absolute",i.textContent="X",this.bufferEl.appendChild(i),t=i.getBoundingClientRect().height,this.bufferEl.removeChild(i),t>0&&(this._measuredLineHeight=t)}(!t||t<=0)&&(t=19.6);let e=this.bufferEl.clientHeight||this.bufferEl.getBoundingClientRect().height,s=Math.floor(e/t);this.viewportRows=s>0?s:30}scheduleRender(){this._renderScheduled||(this._renderScheduled=!0,requestAnimationFrame(()=>{this._renderScheduled=!1,this.render()}))}render(){if(!this.viewportEl||!this.isVisible||this.videoPlayer)return;this._calculateViewport();let t=Math.max(0,this.lines.length-1);this.scrollTop=Math.max(0,Math.min(this.scrollTop,t));let e=document.createDocumentFragment(),s=this.viewportRows||30;for(let i=this.scrollTop;i<this.scrollTop+s;i++){let n=document.createElement("div");n.className="vim-line";let r=document.createElement("span");r.className="vim-gutter";let h=document.createElement("span");if(h.className="vim-line-content",i<this.lines.length){r.textContent=String(i+1);let o=this.lines[i];this._renderLineContent(h,o,i)}else r.textContent="",h.textContent="~",h.classList.add("vim-tilde");n.appendChild(r),n.appendChild(h),e.appendChild(n)}this.viewportEl.innerHTML="",this.viewportEl.appendChild(e),this._updateStatusline()}_renderLineContent(t,e,s){if(!e){t.textContent="";return}let i=e.text||"";if(e.type==="video-placeholder"){t.classList.add("line-video-placeholder"),t.textContent=i,this._applyCursor(t,i,s);return}if(e.type==="ascii-art"){t.classList.add("line-ascii-art"),t.textContent=i,this._applyCursor(t,i,s);return}if(e.type==="separator"){t.classList.add("line-separator"),t.textContent=i;return}if(e.type==="code"){t.classList.add("line-code"),t.textContent=i,this._applySearchHighlight(t,s),this._applyCursor(t,i,s);return}if(e.type&&e.type.startsWith("heading")){let n=e.level||1;t.classList.add("line-heading",`line-heading-${n}`)}e.links&&e.links.length>0?this._renderTextWithLinks(t,i,e.links,s):(t.textContent=i,this._applySearchHighlight(t,s),this._applyCursor(t,i,s))}_renderTextWithLinks(t,e,s,i){let n=0,r=[],h=[...s].sort((o,a)=>o.start-a.start);for(let o of h)o.start>n&&r.push({text:e.slice(n,o.start),type:"text"}),r.push({text:e.slice(o.start,o.end),type:"link",href:o.href}),n=o.end;n<e.length&&r.push({text:e.slice(n),type:"text"});for(let o of r)if(o.type==="link"){let a=document.createElement("span");a.className="line-link",a.textContent=o.text,a.dataset.href=o.href,a.addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),window.location.href=o.href}),t.appendChild(a)}else t.appendChild(document.createTextNode(o.text));this._applySearchHighlight(t,i),this._applyCursor(t,e,i)}_applySearchHighlight(t,e){let s=this.searchPattern;if(!s)return;let n=e===this.searchCurrentLine?"vim-search-current":"vim-search-match",r=[],h=document.createTreeWalker(t,NodeFilter.SHOW_TEXT),o;for(;o=h.nextNode();)r.push(o);for(let a of r){let p=a.textContent,f=p.toLowerCase(),v=f.indexOf(s);if(v===-1)continue;let g=document.createDocumentFragment(),u=0,d=v,x=a.parentNode,m=p,w=f,k=0;for(;;){let E=w.indexOf(s);if(E===-1)break;E>0&&g.appendChild(document.createTextNode(m.slice(0,E)));let b=document.createElement("span");b.className=n,b.textContent=m.slice(E,E+s.length),g.appendChild(b),m=m.slice(E+s.length),w=w.slice(E+s.length)}m&&g.appendChild(document.createTextNode(m)),x.replaceChild(g,a)}}_applyCursor(t,e,s){if(s!==this.cursorRow)return;let i=this.cursorCol;if((e||"").length===0){let a=document.createElement("span");a.className="vim-cursor",a.textContent=" ",t.textContent="",t.appendChild(a);return}if(t.childNodes.length===1&&t.childNodes[0].nodeType===Node.TEXT_NODE){let a=t.textContent,p=a.slice(0,i),f=i<a.length?a[i]:" ",v=i<a.length?a.slice(i+1):"";t.textContent="",p&&t.appendChild(document.createTextNode(p));let g=document.createElement("span");g.className="vim-cursor",g.textContent=f,t.appendChild(g),v&&t.appendChild(document.createTextNode(v));return}let r=0,h=Array.from(t.childNodes);for(let a of h){let p=a.textContent||"",f=p.length;if(i>=r&&i<r+f){let v=i-r;if(a.nodeType===Node.TEXT_NODE){let g=p.slice(0,v),u=p[v],d=p.slice(v+1),x=document.createDocumentFragment();g&&x.appendChild(document.createTextNode(g));let m=document.createElement("span");m.className="vim-cursor",m.textContent=u,x.appendChild(m),d&&x.appendChild(document.createTextNode(d)),t.replaceChild(x,a)}else if(a.nodeType===Node.ELEMENT_NODE){let g=a.textContent,u=g.slice(0,v),d=g[v],x=g.slice(v+1);a.textContent="",u&&a.appendChild(document.createTextNode(u));let m=document.createElement("span");m.className="vim-cursor",m.textContent=d,a.appendChild(m),x&&a.appendChild(document.createTextNode(x))}return}r+=f}let o=document.createElement("span");o.className="vim-cursor",o.textContent=" ",t.appendChild(o)}_updateStatusline(){if(!this.statusline)return;let t=this.lines.length,e=this.viewportRows||30,s;t<=e?s="All":this.scrollTop===0?s="Top":this.scrollTop+e>=t?s="Bot":s=Math.round(this.scrollTop/(t-e)*100)+"%",this.statusline.update({cursor:{row:this.cursorRow+1,col:this.cursorCol+1},scroll:s,file:window.location.href})}showHints(t){this._clearHints();let e=this.viewportEl.querySelectorAll(".line-link");for(let s of e){let i=s.dataset.href,n=t.get(i);if(n){let r=document.createElement("span");r.className="vim-hint-label",r.textContent=n;let h=s.getBoundingClientRect(),o=this.bufferEl.getBoundingClientRect();r.style.left=h.left-o.left+"px",r.style.top=h.top-o.top+"px",this.bufferEl.appendChild(r)}}}_clearHints(){let t=this.bufferEl?.querySelectorAll(".vim-hint-label");t&&t.forEach(e=>e.remove())}clearHints(){this._clearHints()}setSearch(t,e,s){this.searchPattern=t.toLowerCase(),this.searchMatchLines=new Set(e),this.searchCurrentLine=s,this.scheduleRender()}clearSearch(){this.searchPattern="",this.searchMatchLines.clear(),this.searchCurrentLine=-1,this.scheduleRender()}startVideoMode(t){this._savedVideoState={scrollTop:this.scrollTop,cursorRow:this.cursorRow,cursorCol:this.cursorCol},this.videoPlayer=t,t.start(this.viewportEl)}stopVideoMode(){this.videoPlayer&&(this.videoPlayer.stop(),this.videoPlayer=null),this._savedVideoState&&(this.scrollTop=this._savedVideoState.scrollTop,this.cursorRow=this._savedVideoState.cursorRow,this.cursorCol=this._savedVideoState.cursorCol,this._savedVideoState=null),this.render()}getCommandline(){return this.commandline}getStatusline(){return this.statusline}_getCSS(){return`
:host {
  all: initial;
  font-family: 'Menlo', 'Monaco', 'Courier New', 'Consolas', monospace;
  font-size: 14px;
  line-height: 1.4;
  color: ${c.text};
  background: ${c.bg};
}

.vimascii-root {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  z-index: 2147483647;
  display: grid;
  grid-template-rows: 1fr auto auto;
  background: ${c.bg};
  font-family: 'Menlo','Monaco','Courier New','Consolas',monospace;
  font-size: 14px;
  line-height: 1.4;
  color: ${c.text};
  overflow: hidden;
}

.vim-buffer {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  cursor: text;
  min-height: 0;
  min-width: 0;
}

.vim-buffer-viewport { flex: 1; overflow: hidden; min-height: 0; }

.vim-line {
  display: flex;
  white-space: pre;
  height: 1.4em;
  min-height: 1.4em;
}

.vim-gutter {
  display: inline-block;
  width: 5ch; min-width: 5ch;
  text-align: right;
  padding-right: 1ch;
  color: ${c.gutter};
  background: ${c.gutterBg};
  user-select: none;
  flex-shrink: 0;
}

.vim-line-content {
  flex: 1;
  padding-left: 1ch;
  overflow: hidden;
}

.vim-tilde { color: ${c.tilde}; }

.line-heading { font-weight: bold; }
.line-heading-1 { color: ${c.heading}; }
.line-heading-2 { color: #fab387; }
.line-heading-3 { color: ${c.keyword}; }
.line-heading-4 { color: ${c.string}; }
.line-heading-5 { color: ${c.link}; }
.line-heading-6 { color: ${c.linkVisited}; }

.line-link {
  color: ${c.link};
  text-decoration: underline;
  cursor: pointer;
}
.line-link:hover { color: #b4d0fb; }

.line-separator { color: ${c.separator}; }
.line-code { color: ${c.code}; background: ${c.codeBg}; }
.line-ascii-art { color: ${c.string}; letter-spacing: 0; }
.line-video-placeholder { color: ${c.modeVideo}; font-weight: bold; }
.line-list-marker { color: ${c.keyword}; }

.vim-cursor { background: ${c.cursor}; color: ${c.bg}; }
.vim-visual-select { background: ${c.visual}; }
.vim-search-match { background: ${c.search}; color: ${c.bg}; }
.vim-search-current { background: #fab387; color: ${c.bg}; }

.vim-statusline {
  display: flex;
  align-items: center;
  background: ${c.statusBg};
  color: ${c.statusText};
  height: 1.4em;
  padding: 0 1ch;
  user-select: none;
  white-space: nowrap;
  overflow: hidden;
}

.vim-statusline-mode {
  font-weight: bold;
  padding: 0 1ch;
  margin-right: 1ch;
}

.vim-statusline-mode-normal { background: ${c.modeNormal}; color: ${c.bg}; }
.vim-statusline-mode-visual { background: ${c.modeVisual}; color: ${c.bg}; }
.vim-statusline-mode-command { background: ${c.modeCommand}; color: ${c.bg}; }
.vim-statusline-mode-hint { background: ${c.modeInsert}; color: ${c.bg}; }
.vim-statusline-mode-video { background: ${c.modeVideo}; color: ${c.bg}; }

.vim-statusline-file {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
}

.vim-statusline-pos { margin-left: 2ch; color: ${c.subtext}; }
.vim-statusline-scroll { margin-left: 2ch; width: 5ch; text-align: right; color: ${c.subtext}; }

.vim-commandline {
  display: flex;
  align-items: center;
  background: ${c.commandBg};
  color: ${c.commandText};
  height: 1.4em;
  padding: 0 1ch;
  white-space: nowrap;
}

.vim-commandline-prefix { color: ${c.keyword}; }

.vim-commandline-input {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: ${c.commandText};
  font-family: inherit;
  font-size: inherit;
  padding: 0; margin: 0;
}

.vim-commandline-message { color: ${c.subtext}; }
.vim-commandline-error { color: ${c.heading}; }

.vim-hint-label {
  position: absolute;
  background: ${c.keyword};
  color: ${c.bg};
  font-weight: bold;
  font-size: 12px;
  padding: 0 3px;
  z-index: 10;
  border-radius: 2px;
}

.vim-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: ${c.subtext};
}

@keyframes vim-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.vim-loading-spinner {
  margin-bottom: 1em;
  animation: vim-spin 1s linear infinite;
  width: 24px; height: 24px;
  border: 2px solid ${c.overlay};
  border-top-color: ${c.link};
  border-radius: 50%;
}

.vim-loading-text { font-size: 16px; }
`}};var W=class{constructor(t){this.video=t,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.preEl=null,this.progressEl=null,this.container=null,this._rafId=null,this._lastFrameTime=0,this._frameInterval=1e3/X,this._cols=0,this._rows=0,this._running=!1;let e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};this._escapedRamp=Array.from(R,s=>e[s]||s),this._rampMax=R.length-1,this._quantShift=3}start(t){this.container=t,t.innerHTML="",this.preEl=document.createElement("pre"),this.preEl.style.cssText="margin:0;padding:0;overflow:hidden;flex:1;line-height:1;font-size:inherit;color:inherit;white-space:pre;",t.appendChild(this.preEl),this.progressEl=document.createElement("pre"),this.progressEl.style.cssText="margin:0;padding:4px 1ch;line-height:1.4;font-size:inherit;color:inherit;white-space:pre;flex-shrink:0;",t.appendChild(this.progressEl),this._calculateDimensions(),this.video.paused&&this.video.play().catch(()=>{}),this._running=!0,this._lastFrameTime=0,this._rafId=requestAnimationFrame(e=>this._loop(e))}_loop(t){if(!this._running)return;let e=t-this._lastFrameTime;e>=this._frameInterval&&(this._lastFrameTime=t-e%this._frameInterval,this._captureAndRender(),this._updateProgressBar()),this._rafId=requestAnimationFrame(s=>this._loop(s))}_captureAndRender(){if(!(!this.video||!this.preEl)&&(this._calculateDimensions(),!(this._cols<1||this._rows<1))){this.canvas.width=this._cols,this.canvas.height=this._rows;try{this.ctx.drawImage(this.video,0,0,this._cols,this._rows);let t=this.ctx.getImageData(0,0,this._cols,this._rows);this.preEl.innerHTML=this._pixelsToColoredHtml(t.data,this._cols,this._rows)}catch{this.preEl.textContent=`

  [DRM protected content - cannot capture video frames]`}}}_pixelsToColoredHtml(t,e,s){let i=this._escapedRamp,n=this._rampMax,r=this._quantShift,h=[];for(let o=0;o<s;o++){let a="",p=-1,f=-1,v=-1;for(let g=0;g<e;g++){let u=(o*e+g)*4,d=t[u],x=t[u+1],m=t[u+2],w=.299*d+.587*x+.114*m,k=i[Math.floor(w/255*n)],E=d>>r,b=x>>r,y=m>>r;E!==p||b!==f||y!==v?(a&&h.push(`<span style="color:rgb(${p<<r},${f<<r},${v<<r})">${a}</span>`),a=k,p=E,f=b,v=y):a+=k}a&&h.push(`<span style="color:rgb(${p<<r},${f<<r},${v<<r})">${a}</span>`),o<s-1&&h.push(`
`)}return h.join("")}_updateProgressBar(){if(!this.progressEl||!this.video)return;let t=this.video,e=t.currentTime||0,s=t.duration||0,i=t.paused?"\u23F8":"\u25B6",n=t.playbackRate.toFixed(1),r=t.muted?"\u{1F507}":`\u{1F50A}${Math.round(t.volume*100)}%`,h=Math.max(10,this._cols-30),o=s>0?e/s:0,a=Math.round(o*h),p="=".repeat(a)+">"+"-".repeat(Math.max(0,h-a-1));this.progressEl.textContent=`${i} ${this._formatTime(e)} [${p}] ${this._formatTime(s)} [${n}x] ${r}`}_calculateDimensions(){if(!this.container)return;let t=this.container.getBoundingClientRect(),e=8.4,s=14,i=t.height-30,n=t.width;if(this._cols=Math.max(10,Math.floor(n/e)),this._rows=Math.max(5,Math.floor(i/s)),this.video.videoWidth&&this.video.videoHeight){let r=this.video.videoWidth/this.video.videoHeight;this._cols*e/(this._rows*s)>r?this._cols=Math.max(10,Math.floor(this._rows*s*r/e)):this._rows=Math.max(5,Math.floor(this._cols*e/(r*s)))}}_formatTime(t){if(!isFinite(t))return"--:--";let e=Math.floor(t/60),s=Math.floor(t%60);return`${String(e).padStart(2,"0")}:${String(s).padStart(2,"0")}`}togglePlay(){this.video.paused?this.video.play().catch(()=>{}):this.video.pause()}seek(t){this.video.currentTime=Math.max(0,Math.min(this.video.currentTime+t,this.video.duration||0))}adjustVolume(t){this.video.volume=Math.max(0,Math.min(1,this.video.volume+t))}toggleMute(){this.video.muted=!this.video.muted}adjustSpeed(t){this.video.playbackRate=Math.max(.25,Math.min(4,this.video.playbackRate+t))}stop(){this._running=!1,this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=null),this.video.pause(),this.preEl&&this.preEl.parentNode&&this.preEl.parentNode.removeChild(this.preEl),this.progressEl&&this.progressEl.parentNode&&this.progressEl.parentNode.removeChild(this.progressEl),this.preEl=null,this.progressEl=null,this.container=null}};var F=class{constructor(t){this.overlay=t,this.mode=_.NORMAL,this.pendingKey=null,this.pendingTimer=null,this.searchPattern="",this.searchMatches=[],this.searchIndex=-1,this.visualAnchor=null,this.hintMap=new Map,this.hintLabelMap=new Map,this.onQuit=null,this._cmdPrefix="",this._handleKeyDown=this._handleKeyDown.bind(this)}attach(){window.addEventListener("keydown",this._handleKeyDown,!0)}detach(){window.removeEventListener("keydown",this._handleKeyDown,!0),this._clearPending()}_handleKeyDown(t){if(!this.overlay.isVisible||t.isComposing||t.keyCode===229)return;let e=this._normalizeKey(t);if(!e)return;let s=!1;switch(this.mode){case _.NORMAL:s=this._handleNormal(e,t);break;case _.COMMAND:s=this._handleCommand(e,t);break;case _.VISUAL:s=this._handleVisual(e,t);break;case _.HINT:s=this._handleHint(e,t);break;case _.VIDEO:s=this._handleVideo(e,t);break}s&&(t.preventDefault(),t.stopPropagation())}_normalizeKey(t){if(t.key==="Control"||t.key==="Shift"||t.key==="Alt"||t.key==="Meta")return null;let e=t.key;return t.ctrlKey&&(e="C-"+e.toLowerCase()),e}_handleNormal(t,e){let s=this.overlay,{row:i,col:n}=s.getCursor(),r=s.getTotalLines(),h=s.getViewportRows();if(this.pendingKey==="g")return this._clearPending(),t==="g"?(s.setCursor(0,0),s.scrollTo(0),!0):!1;if(this.pendingKey==="Z")return this._clearPending(),t==="Z"?(this.onQuit&&this.onQuit(),!0):!1;switch(t){case"j":return s.setCursor(i+1,n),!0;case"k":return s.setCursor(i-1,n),!0;case"h":return s.setCursor(i,n-1),!0;case"l":return s.setCursor(i,n+1),!0;case"C-d":return s.setCursor(i+O.HALF_PAGE,n),!0;case"C-u":return s.setCursor(i-O.HALF_PAGE,n),!0;case"C-f":return s.setCursor(i+O.PAGE,n),!0;case"C-b":return s.setCursor(i-O.PAGE,n),!0;case"g":return this._setPending("g"),!0;case"G":return s.setCursor(r-1,0),!0;case"Z":return this._setPending("Z"),!0;case"0":return s.setCursor(i,0),!0;case"$":return s.setCursor(i,1/0),this._clampColToLineEnd(),!0;case"^":{let p=(s.lines[i]?.text||"").search(/\S/);return s.setCursor(i,p>=0?p:0),!0}case"w":return this._wordForward(),!0;case"b":return this._wordBackward(),!0;case"Enter":{let o=s.lines[i];return o?.type==="video-placeholder"&&o.videoElement?(this.enterVideoMode(o.videoElement),!0):(this._followLinkOnCursorLine(),!0)}case":":return this._enterCommandMode(":"),!0;case"/":return this._enterCommandMode("/"),!0;case"n":return this._nextSearchMatch(1),!0;case"N":return this._nextSearchMatch(-1),!0;case"v":return this._enterVisual(),!0;case"f":return this._enterHintMode(),!0;case"Escape":return this.searchMatches=[],this.overlay.clearSearch(),this.overlay.getCommandline()?.clear(),!0;default:return!1}}_handleCommand(t,e){let s=this.overlay.getCommandline();if(t==="Escape")return this._exitCommandMode(),!0;if(t==="Enter"){let i=s?.getInputValue()||"",n=this._cmdPrefix+i;return this._exitCommandMode(),this._executeCommand(n),!0}if(t==="Backspace"){let i=s?.getInputValue()||"";return i.length===0?(this._exitCommandMode(),!0):(s?.inputEl&&(s.inputEl.value=i.slice(0,-1)),!0)}return t.length===1&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&s?.inputEl&&(s.inputEl.value+=t),!0}_handleVisual(t,e){let s=this.overlay,{row:i,col:n}=s.getCursor();switch(t){case"Escape":case"v":return this._exitVisual(),!0;case"j":return s.setCursor(i+1,n),!0;case"k":return s.setCursor(i-1,n),!0;case"h":return s.setCursor(i,n-1),!0;case"l":return s.setCursor(i,n+1),!0;case"y":{let r=this._getVisualText();return r&&(navigator.clipboard?.writeText(r).catch(()=>{}),this.overlay.getCommandline()?.showMessage(`${r.split(`
`).length} lines yanked`)),this._exitVisual(),!0}default:return!1}}_handleHint(t,e){if(t==="Escape")return this._exitHintMode(),!0;let s=this.hintMap.get(t);return s?(this._exitHintMode(),this._navigate(s),!0):(this._exitHintMode(),!0)}_setPending(t){this._clearPending(),this.pendingKey=t,this.pendingTimer=setTimeout(()=>{this.pendingKey=null},Q)}_clearPending(){this.pendingKey=null,this.pendingTimer&&(clearTimeout(this.pendingTimer),this.pendingTimer=null)}_enterCommandMode(t){this.mode=_.COMMAND,this._cmdPrefix=t,this.overlay.getStatusline()?.setMode(_.COMMAND),this.overlay.getCommandline()?.activate(t)}_exitCommandMode(){this.mode=_.NORMAL,this._cmdPrefix="",this.overlay.getStatusline()?.setMode(_.NORMAL),this.overlay.getCommandline()?.deactivate()}_executeCommand(t){if(this._exitCommandMode(),t.startsWith(":")){let e=t.slice(1).trim();if(/^(q!?|quit!?|wq!?|x!?|xa!?)$/.test(e)){this.onQuit&&this.onQuit();return}if(e.match(/^\d+$/)){let s=parseInt(e)-1;this.overlay.setCursor(s,0);return}this.overlay.getCommandline()?.showMessage(`E492: Not an editor command: ${e}`,!0);return}if(t.startsWith("/")){let e=t.slice(1);e&&(this.searchPattern=e,this._performSearch())}}_performSearch(){this.searchMatches=[];let t=this.searchPattern.toLowerCase(),e=this.overlay.lines;for(let s=0;s<e.length;s++)(e[s].text||"").toLowerCase().includes(t)&&this.searchMatches.push(s);if(this.searchMatches.length>0){let{row:s}=this.overlay.getCursor();this.searchIndex=this.searchMatches.findIndex(i=>i>=s),this.searchIndex===-1&&(this.searchIndex=0),this.overlay.setCursor(this.searchMatches[this.searchIndex],0),this.overlay.setSearch(this.searchPattern,this.searchMatches,this.searchMatches[this.searchIndex]),this.overlay.getCommandline()?.showMessage(`/${this.searchPattern}  [${this.searchIndex+1}/${this.searchMatches.length}]`)}else this.overlay.clearSearch(),this.overlay.getCommandline()?.showMessage(`Pattern not found: ${this.searchPattern}`,!0)}_nextSearchMatch(t){this.searchMatches.length!==0&&(this.searchIndex=(this.searchIndex+t+this.searchMatches.length)%this.searchMatches.length,this.overlay.setCursor(this.searchMatches[this.searchIndex],0),this.overlay.setSearch(this.searchPattern,this.searchMatches,this.searchMatches[this.searchIndex]),this.overlay.getCommandline()?.showMessage(`/${this.searchPattern}  [${this.searchIndex+1}/${this.searchMatches.length}]`))}_enterVisual(){this.mode=_.VISUAL,this.visualAnchor={...this.overlay.getCursor()},this.overlay.getStatusline()?.setMode(_.VISUAL)}_exitVisual(){this.mode=_.NORMAL,this.visualAnchor=null,this.overlay.getStatusline()?.setMode(_.NORMAL),this.overlay.scheduleRender()}_getVisualText(){if(!this.visualAnchor)return"";let{row:t}=this.visualAnchor,{row:e}=this.overlay.getCursor(),s=Math.min(t,e),i=Math.max(t,e),n=[];for(let r=s;r<=i;r++)n.push(this.overlay.lines[r]?.text||"");return n.join(`
`)}_enterHintMode(){this.mode=_.HINT,this.overlay.getStatusline()?.setMode(_.HINT),this.hintMap.clear(),this.hintLabelMap.clear();let t=this.overlay,e=t.scrollTop,s=Math.min(e+t.getViewportRows(),t.lines.length),i=[];for(let n=e;n<s;n++){let r=t.lines[n];if(r.links)for(let h of r.links)this.hintLabelMap.has(h.href)||i.push(h.href)}for(let n=0;n<i.length&&n<q.length;n++){let r=q[n];this.hintMap.set(r,i[n]),this.hintLabelMap.set(i[n],r)}t.showHints(this.hintLabelMap),t.getCommandline()?.showMessage("-- LINKS --")}_exitHintMode(){this.mode=_.NORMAL,this.hintMap.clear(),this.hintLabelMap.clear(),this.overlay.clearHints(),this.overlay.getStatusline()?.setMode(_.NORMAL),this.overlay.getCommandline()?.clear()}_handleVideo(t,e){switch(t){case" ":return this.overlay.videoPlayer?.togglePlay(),!0;case"h":return this.overlay.videoPlayer?.seek(-U),!0;case"l":return this.overlay.videoPlayer?.seek(U),!0;case"j":return this.overlay.videoPlayer?.adjustVolume(-G),!0;case"k":return this.overlay.videoPlayer?.adjustVolume(G),!0;case"m":return this.overlay.videoPlayer?.toggleMute(),!0;case"[":return this.overlay.videoPlayer?.adjustSpeed(-.25),!0;case"]":return this.overlay.videoPlayer?.adjustSpeed(.25),!0;case"q":case"Escape":return this._exitVideoMode(),!0;default:return!0}}enterVideoMode(t){let e=new W(t);this.mode=_.VIDEO,this.overlay.getStatusline()?.setMode(_.VIDEO),this.overlay.startVideoMode(e),this.overlay.getCommandline()?.showMessage("VIDEO: Space=play/pause h/l=seek j/k=vol m=mute [/]=speed q=quit")}_exitVideoMode(){this.mode=_.NORMAL,this.overlay.stopVideoMode(),this.overlay.getStatusline()?.setMode(_.NORMAL),this.overlay.getCommandline()?.clear()}_wordForward(){let t=this.overlay,{row:e,col:s}=t.getCursor(),r=(t.lines[e]?.text||"").slice(s).match(/^\S*\s+/);r?t.setCursor(e,s+r[0].length):e+1<t.getTotalLines()&&t.setCursor(e+1,0)}_wordBackward(){let t=this.overlay,{row:e,col:s}=t.getCursor();if(s===0&&e>0){let h=t.lines[e-1]?.text||"";t.setCursor(e-1,Math.max(0,h.length-1));return}let n=(t.lines[e]?.text||"").slice(0,s),r=n.match(/\s+\S*$/);if(r){let h=s-r[0].length,o=n.slice(h).search(/\S/);t.setCursor(e,h+(o>=0?o:0))}else t.setCursor(e,0)}_clampColToLineEnd(){let t=this.overlay,{row:e}=t.getCursor(),i=(t.lines[e]?.text||"").length;t.cursorCol>=i&&(t.cursorCol=Math.max(0,i-1))}_followLinkOnCursorLine(){let{row:t}=this.overlay.getCursor(),e=this.overlay.lines[t];e?.links&&e.links.length>0&&this._navigate(e.links[0].href)}_navigate(t){window.location.href=t}};var M=null,N=null,V=!1;async function lt(){if(!V){V=!0,M=new B,M.create(),M.show(),wt();try{let l=et(document.body);if(!l.some(s=>s.type==="video")){let s=document.querySelector("video");if(s){let i=s.getBoundingClientRect();i.width>0&&i.height>0&&l.push({type:"video",domElement:s,width:i.width,height:i.height,indent:0})}}if(await rt(l),!M)return;let t=ot(l);M.setLines(t),N=new F(M),N.onQuit=at,N.attach(),M.render();let e=l.find(s=>s.type==="video"&&s.domElement);e&&N.enterVideoMode(e.domElement)}catch(l){console.error("[VimAscii] Error during activation:",l),M?.getCommandline()?.showMessage("Error: "+l.message,!0)}}}function wt(){if(!M||!M.viewportEl)return;M.viewportEl.innerHTML="";let l=document.createElement("div");l.className="vim-loading";let t=document.createElement("div");t.className="vim-loading-spinner";let e=document.createElement("div");e.className="vim-loading-text",e.textContent="Converting page to ASCII...",l.appendChild(t),l.appendChild(e),M.viewportEl.appendChild(l)}function at(){if(V){V=!1,N&&(N.detach(),N=null),M&&(M.destroy(),M=null);try{A.runtime.sendMessage({type:"DEACTIVATE"})}catch{}}}A.runtime.onMessage.addListener((l,t,e)=>(l.type==="TOGGLE_VIMASCII"&&(l.active?lt():at()),!1));Promise.resolve().then(()=>A.runtime.sendMessage({type:"GET_STATE"})).then(l=>{l?.active&&!V&&lt()}).catch(()=>{});})();
